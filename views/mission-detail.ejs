<%
    const escapeHtml = (value) => String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    const safeMissionId = escapeHtml(missionId);
%>
<%- include('layouts/main', { title: 'Mission Detail' , activePage: 'missions' , head: ` <script src="/assets/Build/Cesium/Cesium.js"></script>
	    <style>
	        @import url(/assets/Build/Cesium/Widgets/widgets.css);

	        #missionDetailMap {
	            width: 100%;
	            height: 520px;
	            border-radius: var(--radius-lg);
	            overflow: hidden;
	            background: var(--bg-primary);
	        }
	    </style>
	    `, body: ` <div class="content-area" id="missionDetail" data-mission-id="${safeMissionId}">
	    <!-- Page Header -->
	    <div class="section-header">
	        <div>
	            <h1 class="page-title">Mission: <span id="missionName">--</span></h1>
	            <p class="page-subtitle">View mission details and status</p>
	        </div>
        <div class="flex gap-sm">
            <button class="btn btn-warning" id="abortMission">Abort Mission</button>
            <button class="btn btn-ghost" id="updateAtcSlot" style="display: none;">Update ATC Slot</button>
            <button class="btn btn-success" id="approveMission">Approve</button>
        </div>
    </div>

    <div class="grid-2-col">
        <!-- Left: Mission Info -->
        <div>
            <!-- Status Card -->
            <div class="card mb-md">
                <div class="card-header">
                    <div class="card-title">Mission Status</div>
                </div>
                <div class="card-body">
                    <div class="flex items-center gap-md mb-md">
                        <span class="status-dot flying"></span>
                        <span class="status-badge flying" id="missionStatus">In Progress</span>
                    </div>
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-card">
                            <div class="stat-value" id="progress">45%</div>
                            <div class="stat-label">Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="eta">12:34</div>
                            <div class="stat-label">ETA</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="waypoints">3/8</div>
                            <div class="stat-label">Waypoints</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Details Card -->
            <div class="card mb-md">
                <div class="card-header">
                    <div class="card-title">Mission Details</div>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <span class="detail-label">Drone</span>
                        <span class="detail-value" id="droneId">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type</span>
                        <span class="detail-value" id="missionType">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Created</span>
                        <span class="detail-value" id="createdAt">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Started</span>
                        <span class="detail-value" id="startedAt">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ATC Requested</span>
                        <span class="detail-value" id="atcRequested">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ATC Scheduled</span>
                        <span class="detail-value" id="atcScheduled">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ATC Delay</span>
                        <span class="detail-value" id="atcDelay">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Reservation Expires</span>
                        <span class="detail-value" id="atcExpires">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance</span>
                        <span class="detail-value" id="distance">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Duration</span>
                        <span class="detail-value" id="duration">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Planner Compliance</span>
                        <span class="detail-value" id="plannerCompliance">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Planner Speed</span>
                        <span class="detail-value" id="plannerSpeed">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Planner Altitude</span>
                        <span class="detail-value" id="plannerAltitude">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Max Obstacle</span>
                        <span class="detail-value" id="plannerObstacle">--</span>
                    </div>
                </div>
            </div>

            <!-- Conformance -->
            <div class="card mb-md">
                <div class="card-header">
                    <div class="card-title">Conformance</div>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <span class="detail-label">Status</span>
                        <span class="detail-value" id="conformanceStatus">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Code</span>
                        <span class="detail-value" id="conformanceCode">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Description</span>
                        <span class="detail-value" id="conformanceDescription">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Update</span>
                        <span class="detail-value" id="conformanceUpdated">--</span>
                    </div>
                </div>
            </div>

            <!-- Waypoints -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Waypoints</div>
                </div>
                <div class="card-body" id="waypointList">
                    <div class="list-item">
                        <span class="status-dot online"></span>
                        <div class="list-item-content">
                            <div class="list-item-title">Waypoint 1 (Start)</div>
                            <div class="list-item-subtitle">33.6846, -117.8265 @ 50m</div>
                        </div>
                        <span class="status-badge online">Complete</span>
                    </div>
                    <div class="list-item">
                        <span class="status-dot flying"></span>
                        <div class="list-item-content">
                            <div class="list-item-title">Waypoint 2</div>
                            <div class="list-item-subtitle">33.6850, -117.8270 @ 50m</div>
                        </div>
                        <span class="status-badge flying">In Progress</span>
                    </div>
                    <div class="list-item">
                        <span class="status-dot offline"></span>
                        <div class="list-item-content">
                            <div class="list-item-title">Waypoint 3 (End)</div>
                            <div class="list-item-subtitle">33.6855, -117.8280 @ 50m</div>
                        </div>
                        <span class="status-badge offline">Pending</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Map -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Route Map</div>
            </div>
            <div class="card-body">
                <div id="missionDetailMap"></div>
            </div>
        </div>
    </div>
    </div>
    `,
    scripts: `
    <script src="/assets/js/mission-detail.js"></script>
    `
    }) %>
