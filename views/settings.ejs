<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | ATC-Drone</title>
    <meta name="description" content="ATC-Drone Mission Control - Settings and Configuration">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/mission-control.css">
</head>

<body>
    <div class="app-container">
        <%- include('partials/header', { activePage: 'settings' }) %>

            <main class="main-content">
                <div class="content-area">
                    <div class="page-header">
                        <h1 class="page-title">Settings</h1>
                        <p class="page-subtitle">Account and system configuration</p>
                    </div>

                    <div id="messageContainer"></div>

                    <div class="grid-2-col">
                        <!-- Left Column: Account Settings -->
                        <div>
                            <!-- User Profile -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <div class="card-title">Profile</div>
                                </div>
                                <div class="card-body">
                                    <form action="/account/update-profile" method="POST">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
                                        <div class="form-group">
                                            <label class="form-label">Username</label>
                                            <input type="text" class="form-input" value="<%= user ? user.id : '' %>"
                                                disabled>
                                            <small class="form-help">Username cannot be changed</small>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Display Name</label>
                                            <input type="text" class="form-input" name="name"
                                                value="<%= user ? user.name : '' %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-input" name="email"
                                                value="<%= user ? user.email : '' %>" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Role</label>
                                            <input type="text" class="form-input" value="<%= user ? user.role : '' %>"
                                                disabled>
                                            <small class="form-help">Contact admin to change role</small>
                                        </div>

                                        <button type="submit" class="btn btn-primary">Update Profile</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Change Password -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <div class="card-title">Change Password</div>
                                </div>
                                <div class="card-body">
                                    <form action="/account/change-password" method="POST">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
                                        <div class="form-group">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-input" name="currentPassword" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-input" name="newPassword" required
                                                minlength="6">
                                            <small class="form-help">Minimum 6 characters</small>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-input" name="confirmNewPassword" required
                                                minlength="6">
                                        </div>

                                        <button type="submit" class="btn btn-warning">Change Password</button>
                                    </form>
                                </div>
                            </div>

                            <!-- Session Info -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <div class="card-title">Session</div>
                                </div>
                                <div class="card-body">
                                    <div class="detail-row">
                                        <span class="detail-label">Logged in as</span>
                                        <span class="detail-value">
                                            <%= user ? user.id : 'Unknown' %>
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Session Status</span>
                                        <span class="detail-value"><span class="status-dot online"></span> Active</span>
                                    </div>
                                    <div class="mt-md">
                                        <a href="/logout" class="btn btn-ghost">Sign Out</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Danger Zone -->
                            <div class="card" style="border-color: var(--accent-red);">
                                <div class="card-header">
                                    <div class="card-title" style="color: var(--accent-red);">Danger Zone</div>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted" style="margin-bottom: 16px;">
                                        Once you delete your account, there is no going back.
                                    </p>
                                    <form action="/account/delete" method="POST"
                                        onsubmit="return confirm('Are you sure?');">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
                                        <button type="submit" class="btn btn-danger" <% if (user && (user.id==='guest'
                                            || user.id==='admin' )) { %>disabled<% } %>>
                                                Delete Account
                                        </button>
                                        <% if (user && (user.id==='guest' || user.id==='admin' )) { %>
                                            <small class="form-help" style="color: var(--accent-red);">System accounts
                                                cannot be deleted</small>
                                            <% } %>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: App Settings -->
                        <div>
                            <!-- ATC Server Connection -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <div class="card-title">ATC Server</div>
                                </div>
                                <div class="card-body">
                                    <div class="flex items-center gap-md mb-md">
                                        <span class="status-dot online" id="serverStatusDot"></span>
                                        <span id="serverStatusText">Connected</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Server URL</span>
                                        <span class="detail-value font-mono">http://localhost:3000</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Refresh Rate</span>
                                        <span class="detail-value">1000ms</span>
                                    </div>
	                                    <div class="mt-md">
	                                        <button class="btn btn-ghost" id="testConnectionBtn" type="button">Test Connection</button>
	                                    </div>
	                                </div>
	                            </div>

                            <!-- Safety Settings -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <div class="card-title">Safety Rules</div>
                                </div>
                                <div class="card-body">
                                    <div class="detail-row">
                                        <span class="detail-label">Min Horizontal Separation</span>
                                        <span class="detail-value">100m</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Min Vertical Separation</span>
                                        <span class="detail-value">30m</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Conflict Lookahead</span>
                                        <span class="detail-value">30s</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Drone Timeout</span>
                                        <span class="detail-value">10s</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="card mb-md">
                                <div class="card-header">
                                    <div class="card-title">Notifications</div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="toggle-label">
                                            <input type="checkbox" checked id="notifyConflicts">
                                            <span>Alert on conflict detection</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="toggle-label">
                                            <input type="checkbox" checked id="notifyGeofence">
                                            <span>Alert on geofence violation</span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="toggle-label">
                                            <input type="checkbox" id="soundEnabled">
                                            <span>Enable sound alerts</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- About -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">About</div>
                                </div>
                                <div class="card-body">
                                    <div class="detail-row">
                                        <span class="detail-label">Version</span>
                                        <span class="detail-value">0.5.0</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Project</span>
                                        <span class="detail-value">UCI Senior Project - UTM</span>
                                    </div>
                                    <div class="flex gap-sm mt-md">
                                        <a href="/docs" class="btn btn-ghost btn-sm">SDK Docs</a>
                                        <a href="https://github.com" class="btn btn-ghost btn-sm"
                                            target="_blank">GitHub</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <%- include('partials/status-bar') %>
    </div>

    <script src="/assets/js/api-client.js"></script>
    <script nonce="<%= cspNonce %>">
	        document.addEventListener('DOMContentLoaded', function () {
	            const params = new URLSearchParams(window.location.search);
	            const container = document.getElementById('messageContainer');
	            const testBtn = document.getElementById('testConnectionBtn');
	            if (testBtn) {
	                testBtn.addEventListener('click', testConnection);
	            }

	            if (params.get('updated') === 'profile') {
	                container.innerHTML = '<div class="alert alert-success mb-md">Profile updated successfully!</div>';
	            } else if (params.get('updated') === 'password') {
	                container.innerHTML = '<div class="alert alert-success mb-md">Password changed!</div>';
            } else if (params.get('error') === 'wrong_password') {
                container.innerHTML = '<div class="alert alert-danger mb-md">Current password is incorrect.</div>';
            } else if (params.get('error') === 'password_mismatch') {
                container.innerHTML = '<div class="alert alert-danger mb-md">Passwords do not match.</div>';
            }
        });

        async function testConnection() {
            const dot = document.getElementById('serverStatusDot');
            const text = document.getElementById('serverStatusText');
            try {
                const response = await fetch('/api/atc/v1/drones');
                dot.className = response.ok ? 'status-dot online' : 'status-dot offline';
                text.textContent = response.ok ? 'Connected' : 'Error';
            } catch (e) {
                dot.className = 'status-dot offline';
                text.textContent = 'Failed';
            }
        }
    </script>
</body>

</html>
