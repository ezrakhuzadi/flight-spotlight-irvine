<%- include('layouts/main', { title: 'Plan Mission' , activePage: 'missions' , head: ` <script src="/assets/Build/Cesium/Cesium.js"></script>
    <style>
        @import url(/assets/Build/Cesium/Widgets/widgets.css);

        #missionMap {
            width: 100%;
            height: 100%;
        }

        .waypoint-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 220px;
            overflow-y: auto;
        }

        .waypoint-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .waypoint-item span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .map-shell {
            min-height: 520px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
        }
    </style>
    `,
    body: `
    <div class="content-area">
        <div class="section-header">
            <div>
                <h1 class="page-title">Plan New Mission</h1>
                <p class="page-subtitle">Define a route and submit a flight declaration to Flight Blender</p>
            </div>
            <a href="/control/missions" class="btn btn-ghost">Cancel</a>
        </div>

        <div id="missionMessages"></div>

        <div class="grid-2-col">
            <div class="stacked-col">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Mission Details</div>
                    </div>
                    <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Select Drone</label>
                        <select class="form-select" id="droneSelect">
                            <option value="">-- Select a drone --</option>
                        </select>
                        <small class="form-help">Choose the drone that will execute this mission</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Mission Name</label>
                        <input type="text" class="form-input" id="missionName" placeholder="e.g., Campus Survey Route A">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Mission Type</label>
                        <select class="form-select" id="missionType">
                            <option value="delivery">Delivery</option>
                            <option value="survey">Survey/Mapping</option>
                            <option value="inspection">Infrastructure Inspection</option>
                            <option value="patrol">Patrol Route</option>
                            <option value="custom">Custom Route</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Operation Mode</label>
                        <select class="form-select" id="operationType">
                            <option value="1">VLOS</option>
                            <option value="2">BVLOS</option>
                        </select>
                    </div>

                    <div class="grid-2-col">
                        <div class="form-group">
                            <label class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-input" id="missionStart">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time</label>
                            <input type="datetime-local" class="form-input" id="missionEnd">
                        </div>
                    </div>

                    <div class="grid-2-col">
                        <div class="form-group">
                            <label class="form-label">Min Altitude (m)</label>
                            <input type="number" class="form-input" id="minAltitude" value="30" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Max Altitude (m)</label>
                            <input type="number" class="form-input" id="maxAltitude" value="120" min="0">
                        </div>
                    </div>

                    <div class="section-subtitle mt-lg">Waypoints</div>
                    <div class="text-muted" style="margin-bottom: 8px;">
                        Click on the map to drop waypoints, then optimize to generate a building-aware route.
                    </div>
                    <div class="waypoint-list" id="waypointList">
                        <div class="empty-state" style="padding: 12px;">
                            <div class="empty-state-text text-muted">No waypoints yet</div>
                        </div>
                    </div>

                    <div class="flex gap-sm mt-md">
                        <button class="btn btn-ghost btn-sm" id="removeLastWaypoint">Remove Last</button>
                        <button class="btn btn-ghost btn-sm" id="clearWaypoints">Clear Route</button>
                        <button class="btn btn-ghost btn-sm" id="optimizeRoute">Optimize Route</button>
                    </div>
                    <div class="text-muted mt-sm" id="routeStatus">Route not analyzed yet.</div>

                    <div class="flex gap-sm mt-lg">
                        <button class="btn btn-primary" id="submitMission">Submit Flight Declaration</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Compliance Checklist</div>
                    <div class="flex items-center gap-sm">
                        <button class="btn btn-ghost btn-sm" id="analyzeCompliance">Auto Analyze</button>
                        <span class="status-badge pending" id="complianceOverall">Pending</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="detail-row">
                        <span class="detail-label">Route distance</span>
                        <span class="detail-value" id="routeDistance">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Estimated flight time</span>
                        <span class="detail-value" id="routeDuration">--</span>
                    </div>

                    <div class="compliance-grid mt-md">
                        <div class="compliance-item">
                            <div class="compliance-item-header">
                                <span>Weather</span>
                                <span class="status-badge pending" id="weatherStatus">Pending</span>
                            </div>
                            <div class="grid-2-col">
                                <div class="form-group">
                                    <label class="form-label">Wind (m/s)</label>
                                    <input type="number" class="form-input" id="weatherWind" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gust (m/s)</label>
                                    <input type="number" class="form-input" id="weatherGust" step="0.1" min="0">
                                </div>
                            </div>
                            <div class="grid-2-col">
                                <div class="form-group">
                                    <label class="form-label">Precip (mm)</label>
                                    <input type="number" class="form-input" id="weatherPrecip" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Source</label>
                                    <input type="text" class="form-input" id="weatherSource" value="Manual" readonly>
                                </div>
                            </div>
                            <div class="grid-3-col">
                                <div class="form-group">
                                    <label class="form-label">Max wind</label>
                                    <input type="number" class="form-input" id="weatherMaxWind" value="12" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max gust</label>
                                    <input type="number" class="form-input" id="weatherMaxGust" value="15" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max precip</label>
                                    <input type="number" class="form-input" id="weatherMaxPrecip" value="2" step="0.1" min="0">
                                </div>
                            </div>
                            <div class="compliance-actions">
                                <button class="btn btn-ghost btn-sm" id="fetchWeather">Fetch Weather</button>
                            </div>
                            <div class="compliance-meta" id="weatherMeta">No weather data loaded.</div>
                        </div>

                        <div class="compliance-item">
                            <div class="compliance-item-header">
                                <span>Battery Reserve</span>
                                <span class="status-badge pending" id="batteryStatus">Pending</span>
                            </div>
                            <div class="grid-2-col">
                                <div class="form-group">
                                    <label class="form-label">Battery capacity (min)</label>
                                    <input type="number" class="form-input" id="batteryCapacity" value="25" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reserve requirement (min)</label>
                                    <input type="number" class="form-input" id="batteryReserve" value="5" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cruise speed (m/s)</label>
                                <input type="number" class="form-input" id="cruiseSpeed" value="10" min="1" step="0.5">
                            </div>
                            <div class="compliance-actions">
                                <button class="btn btn-ghost btn-sm" id="autoBattery">Auto Estimate</button>
                            </div>
                            <div class="compliance-meta" id="batteryMeta">Route not evaluated yet.</div>
                        </div>

                        <div class="compliance-item">
                            <div class="compliance-item-header">
                                <span>Population Density</span>
                                <span class="status-badge pending" id="populationStatus">Pending</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Area classification</label>
                                <select class="form-select" id="populationClass">
                                    <option value="rural">Rural</option>
                                    <option value="suburban" selected>Suburban</option>
                                    <option value="urban">Urban</option>
                                    <option value="dense">Dense Urban</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Population density (people/km^2)</label>
                                <input type="number" class="form-input" id="populationDensity" value="1000" min="0" step="10">
                            </div>
                            <div class="compliance-meta" id="populationMeta">Awaiting density input.</div>
                        </div>

                        <div class="compliance-item">
                            <div class="compliance-item-header">
                                <span>Obstacle Hazards</span>
                                <span class="status-badge pending" id="obstacleStatus">Pending</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Minimum clearance (m)</label>
                                <input type="number" class="form-input" id="obstacleClearance" value="60" min="10" step="5">
                            </div>
                            <div class="compliance-meta" id="obstacleMeta">No route to evaluate.</div>
                            <div class="compliance-meta" id="obstacleList"></div>
                        </div>
                    </div>

                    <div class="section-subtitle mt-lg">Override</div>
                    <label class="toggle-label">
                        <input type="checkbox" id="complianceOverride">
                        Allow submission with failed checks (requires notes)
                    </label>
                    <div class="form-group mt-sm">
                        <label class="form-label">Override notes</label>
                        <textarea class="form-input" id="complianceNotes" placeholder="Explain the mitigation and approval justification."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Route Preview</div>
            </div>
            <div class="card-body">
                <div class="map-shell">
                    <div id="missionMap"></div>
                </div>
            </div>
        </div>
    </div>
    `,
    scripts: `
    <script src="/assets/planner/src/route-engine.js"></script>
    <script src="/assets/js/route-planner.js"></script>
    <script src="/assets/js/mission-plan.js"></script>
    `
    }) %>
